function dump(e){var t="";for(var a in e)t=t+"<br> "+a+": "+e[a];return t}function beLogin(){$(".logout").attr("class","login").text("Sign in"),$(".log_state").text("游客您好！")}function beLogout(e){var t=e||Cookies.get("adminName")||"";""===t?beLogin():($(".login").attr("class","logout").text("Sign out"),$(".log_state").text(t))}var POSTERS_PATH="uploads/posters/",IMAGES_PATH="uploads/images/",AdminSerials=function(e){"use strict";function t(){i(),n()}function a(){o.api().ajax.url("doSerialsAdmin.php?act=get&page=1&pageSize=999").load(),$(r).show()}function i(){o=$("#serials_list").dataTable({autoWidth:!1,ordering:!0,order:[[0,"desc"]],jQueryUI:!0,pagingType:"full_numbers",ajax:{url:"doSerialsAdmin.php?act=get&page=1&pageSize=0",dataSrc:function(e){var t,a,i,n,s=e.data;for(t=0,i=s.length;t<i;t++){var r=s[t].posters,o=s[t].images,d="",l="";for(a=0,n=r.length;a<n;a++)d+="<a target='_blank' href='"+POSTERS_PATH+r[a]+"'>"+(a+1)+" </a>";for(a=0,n=o.length;a<n;a++)l+="<a target='_blank' href='"+IMAGES_PATH+o[a]+"'>"+(a+1)+" </a>";d=d?d:"无",l=l?l:"无",s[t].posters=d,s[t].images=l;var c=s[t].synopsis?s[t].synopsis:"";s[t].synopsis=c.length>20?c.substring(0,10)+"...":c,s[t].operate="<button data-id="+s[t].id+" class='update_btn'>修改</button><button data-id="+s[t].id+" class='delete_btn'>删除</button>"}return s}},columns:[{data:"id",width:"0%"},{data:"c_name",width:"0%"},{data:"f_name",width:"0%"},{data:"director",width:"0%"},{data:"actors",width:"0%"},{data:"district",width:"0%"},{data:"types",width:"0%"},{data:"tags",width:"0%"},{data:"issuer",width:"0%"},{data:"release_date",width:"0%"},{data:"duration",width:"0%"},{data:"episode_number",width:"0%"},{data:"season_number",width:"0%"},{data:"reco_index",width:"0%"},{data:"type_index",width:"0%"},{data:"douban_index",width:"0%"},{data:"state",width:"0%"},{data:"synopsis",width:"0%"},{data:"posters",width:"0%"},{data:"images",width:"0%"},{data:"date",width:"0%"},{data:"operate",width:"0%"}],language:{lengthMenu:"每页显示_MENU_条",search:"查找",info:"共有(_MAX_)条,(_PAGES_)页",paginate:{first:"首页",previous:"上一页",next:"下一页",last:"末页"}}}),$("#serials_list").magnificPopup({delegate:"a",type:"image"}),$("#types").tagsInput({width:"auto",height:"auto",interactive:!0,defaultText:"添加类型",delimiter:[",",";","/"," "],maxChars:10}),$("#actors").tagsInput({width:"auto",height:"auto",interactive:!0,defaultText:"添加演员",delimiter:[",",";","/"],maxChars:30}),$("#tags").tagsInput({width:"auto",height:"auto",interactive:!0,defaultText:"添加标签",delimiter:[",",";","/"," "],maxChars:10}),$("#episode_number").spinner({min:0,max:100,page:3}),$("#season_number").spinner({min:0,max:100,page:3}),$(".index").spinner({min:0,max:10,page:10,step:.1}),$("#duration").spinner({min:0,max:511,page:10,step:1}),$("#state").selectmenu(),$("#district").selectmenu(),$("#autoLogin").checkboxradio({label:"custom label"}),$(".serials_update_accordion").accordion({active:!1,collapsible:!0,heightStyle:"content",allCollapsible:!0}),$("#posters").fineUploader({request:{paramsInBody:!1,endpoint:"./doSerialsAdmin.php"},validation:{acceptFiles:["jpeg","jpg","png","gif"],sizeLimit:1048576},deleteFile:{enabled:!0,params:{act:"upload_posters"},forceConfirm:!0,endpoint:"./doSerialsAdmin.php"}}).on("error",function(e,t,a,i){console.log("error:"+t+" name: reason:"+i)}).on("complete",function(e,t,a,i){console.log("id: "+t+"\nname: "+a+"\nJSON: "+dump(i))}).on("deleteComplete",function(e,t,a,i){console.log("id: "+t+"\n xhr:"+dump(a)+"\n isError:"+i)}).on("submit",function(){$("#posters").fineUploader("setParams",{act:"upload_posters",id:d})}),$("#images").fineUploader({request:{paramsInBody:!1,params:{act:"upload_images",id:0},endpoint:"./doSerialsAdmin.php"},validation:{acceptFiles:["jpeg","jpg","png","gif"],sizeLimit:1048576},deleteFile:{enabled:!0,params:{act:"upload_images"},forceConfirm:!0,endpoint:"./doSerialsAdmin.php"}}).on("error",function(e,t,a,i){alert("error:"+t+" name: reason:"+i)}).on("complete",function(e,t,a,i){alert("id: "+t+"\nname: "+a+"\nJSON: "+dump(i))}).on("deleteComplete",function(e,t,a,i){alert("id: "+t+"\n xhr:"+dump(a)+"\n isError:"+i)}).on("submit",function(){$("#images").fineUploader("setParams",{act:"upload_images",id:d})})}function n(){$("#insert_serials").on("submit","form",function(e){var t={};e.preventDefault(),t={url:"doSerialsAdmin.php?act=insert",data:$(this).serialize(),method:"post",success:function(e){var t=JSON.parse(e);t.error?alert(t.error):(alert("添加成功"),d=t.id,$("#submit_all_btn").attr("class","update_it").text("提 交"),$("#update_serials").click(),$("#update_serial_name").val($("#serial_name").val()),$("#update_serial_fname").val($("#serial_fname").val()))}},$.ajax(t)}),$("#submit_all_btn").on("click",function(){var e=$("#update_name").serialize()+"&"+$("#add_participant").serialize()+"&"+$("#add_classification").serialize()+"&"+$("#add_episode_time").serialize()+"&"+$("#add_index").serialize()+"&"+$("#add_synopsis").serialize(),t={},a={};t={url:"doSerialsAdmin.php?act=update&id="+d,data:e,method:"post",success:function(e){var t=JSON.parse(e);t.error?alert(t.error):(alert("更新成功！"),s())}},a={url:"doSerialsAdmin.php?act=insert",data:e,method:"post",success:function(e){var t=JSON.parse(e);t.error?alert(t.error):(alert("添加成功！"),d=t.id,$("#submit_all_btn").attr("class","update_it").text("提 交"))}},"update_it"==$(this).attr("class")&&$.ajax(t),"add_new"==$(this).attr("class")&&$.ajax(a)}),$("#delete_it_btn").on("click",function(){if(!(d>0))return void alert("未选中条目！");if(confirm("确认要删除这条数据？")){var e={type:"post",url:"doSerialsAdmin.php?act=delete&id="+d,error:function(){},success:function(e){var t=JSON.parse(e);return t.success?(s(),void alert("删除成功")):void alert(t.error)}};$.ajax(e)}}),$("#cancel_it_btn").on("click",function(){s()}),$("#serials_list").on("click",".update_btn",function(){d=$(this).attr("data-id");var e={type:"get",url:"doSerialsAdmin.php?act=get&id="+d,error:function(){alert("获取数据失败")},success:function(e){var t=JSON.parse(e),a=t.data[0];console.log(e),$("#update_serial_name").val(a.c_name),$("#update_serial_fname").val(a.f_name),$("#director").val(a.director),$("#actors").importTags(a.actors),$("#issuer").val(a.issuer),$("#types").importTags(a.types),$("#district option").filter("[selected=selected]").removeAttr("selected"),$("#district option").filter("[value="+a.district+"]").attr("selected",!0),$("#district").selectmenu("refresh"),$("#state option").filter("[selected=selected]").removeAttr("selected"),$("#state option").filter("[value="+a.state+"]").attr("selected",!0),$("#state").selectmenu("refresh"),$("#tags").importTags(a.tags),$("#release_date").val(a.release_date),$("#duration").val(a.duration),$("#episode_number").val(a.episode_number),$("#season_number").val(a.season_number),$("#update_reco_index").val(a.reco_index),$("#update_type_index").val(a.type_index),$("#update_douban_index").val(a.douban_index),$("#update_synopsis").val(a.synopsis),$("#submit_all_btn").attr("class","update_it").text("提 交"),$("#update_serials").click()}};$.ajax(e)}),$("#serials_list").on("click",".delete_btn",function(){if(confirm("确定要删除这条数据？")){var e={type:"post",url:"doSerialsAdmin.php?act=delete&id="+$(this).attr("data-id"),error:function(){},success:function(e){var t=JSON.parse(e);return t.success?(o.api().ajax.url("doSerialsAdmin.php?act=get&page=1&pageSize=999").load(),void alert("删除成功")):void alert(t.error)}};$.ajax(e)}}),$(".serials_update_accordion").on("submit","form",function(e){if(e.preventDefault(),!(d>0))return void alert("请先添加数据");var t=($(this).attr("id"),$(this).serialize()),a={url:"doSerialsAdmin.php?id="+d+"&act=update",data:t,method:"post",success:function(e){var t=JSON.parse(e);t.success?alert("添加成功"):(console.log(e),alert(t.error))}};$.ajax(a)})}function s(){$("#submit_all_btn").attr("class","add_new").text("添 加"),d=0,$("#update_name")[0].reset(),$("#add_participant")[0].reset(),$("#add_classification")[0].reset(),$("#add_episode_time")[0].reset(),$("#add_index")[0].reset(),$("#add_synopsis")[0].reset(),$("#posters").fineUploader("reset"),$("#images").fineUploader("reset")}var r=".serials",o=null,d=0;return{init:t,show:a,hide:function(){$(r).hide()}}}(window),AdminMovies=function(e){var t=".movies";return{show:function(){$(t).show()},hide:function(){$(t).hide()}}}(window),AdminMusics=function(e){var t=".musics";return{show:function(){$(t).show()},hide:function(){$(t).hide()}}}(window),AdminBooks=function(e){var t=".books";return{show:function(){$(t).show()},hide:function(){$(t).hide()}}}(window),AdminAnimations=function(e){var t=".animations",a=function(){$(t).show()},i=function(){$(t).hide()};return{show:a,hide:i}}(window),AdminAdd=function(e){var t="#insert_items",a=function(){$("#insert_music").on("submit",function(){var e=this;$.ajax({type:"post",url:"doMusicsAdmin.php?act=add",data:$(this).serialize(),error:function(){alert("添加失败！")},success:function(t){var a=JSON.parse(t);a&&a.success?(alert("添加音乐成功！"),e.reset()):alert(a.error),console.log(t)}})})};return{init:a,show:function(){$(t).show()},hide:function(){$(t).hide()}}}(window),AdminUpdate=function(e){var t="#serials_update";return{show:function(){$(t).show()},hide:function(){$(t).hide()}}}(window);AdminAdd.init(),AdminSerials.init(),$HOST_URL="http://localhost:80";var AdminServer=function(e){function t(){var e={};e={type:"get",url:"doAdmin.php?act=getServer",error:function(){},success:function(e){var t=JSON.parse(e),a=t.data;$("#server_software").text(a.server_software),$("#server_protocol").text(a.server_protocol),$("#php_os").text(a.php_os),$("#php_sapi_name").text(a.php_sapi_name),$("#mysql_version").text(a.mysql_version)}},$.ajax(e)}return{show:function(){t(),$(".server").show()}}}(window),Show=AdminServer;AdminServer.show(),$(".disabled").attr("title","功能未上线").css({color:"rgba(0,0,0,0.34)",cursor:"default"}).on("click",function(e){e.preventDefault(),e.stopPropagation()}),$("nav").on("click","a",function(e){var t=$(this).attr("id");if(t){e.preventDefault(),Show&&"function"==typeof Show.hide?Show.hide():$("main > div").hide();var a={server:AdminServer,list_movies:AdminMovies,list_serials:AdminSerials,list_animations:AdminAnimations,list_musics:AdminMusics,list_books:AdminBooks,update_movies:AdminUpdate,add_item:AdminAdd,update_serials:AdminUpdate};if("object"!=typeof a[t])throw new Error("Navigate failed:target object doesn't exited");if("function"!=typeof a[t].show)throw new Error("Navigate failed:target object haven't show function");Show=a[t],Show.show()}}),$(".header").on("click","a",function(e){e.preventDefault();var t=$(this).attr("class");"logout"==t&&$.ajax({url:"doSerialsAdmin.php?act=logout",success:function(e){1==JSON.parse(e).success&&beLogin()}}),"login"==t&&$.magnificPopup.open({items:{src:"<div class='white-popup'><form class='loginPanel'><input type='text' name='username'  placeholder='Username'><br><input type='password' name='password' placeholder='Password'><br><input type='radio' id='autoLogin' name='autoLogin'><label for='autoLogin'>Remember me</label><br><button>登录</button></form></div>",type:"inline"}})}),$.ajax({url:"doSerialsAdmin.php?act=login",success:function(e){var t=JSON.parse(e);t.username?beLogout(t.username):beLogin()}}),$("body").on("submit",".loginPanel",function(e){e.preventDefault(),$.ajax({url:"doSerialsAdmin.php?act=login",data:$(".loginPanel").serialize(),type:"post",success:function(e){var t=JSON.parse(e);t.error&&alert(t.error),t.username&&(beLogout(t.username),alert("二货"+t.username+"，开始干活了！"),$.magnificPopup.close())}})}),$("nav#menu").mmenu({extensions:["effect-slide-menu","shadow-panels"],counters:!0,navbar:{title:"Advanced menu"},navbars:[{position:"top",content:["searchfield"]},{position:"top",content:["prev","title","close"]},{position:"bottom",content:['<a href="../index.html" target="_blank">返回前台</a>']}],onClick:{close:!0,setSelected:!0}});var fineUploaderOptions={request:{paramsInBody:!1,params:{act:"upload"},endpoint:"./doSerialsAdmin.php"},validation:{acceptFiles:["jpeg","jpg","png","gif"],sizeLimit:1048576},deleteFile:{enabled:!0,params:{act:"upload"},forceConfirm:!0,endpoint:"./doSerialsAdmin.php"}};